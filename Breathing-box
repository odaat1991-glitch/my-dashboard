<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Breathing Box Relaxation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: white;
        }
        canvas {
            display: block;
        }
        select {
            background-color: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(4px);
            color: #e2e8f0;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        select:focus {
            outline: none;
            border-color: #60a5fa;
            background-color: rgba(0, 0, 0, 0.5);
        }
        /* Style the options to be readable */
        option {
            background-color: #1e293b;
            color: white;
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen">

    <div class="absolute top-0 left-0 w-full h-full flex items-center justify-center -z-10">
        <canvas id="breathCanvas"></canvas>
    </div>

    <!-- UI Overlay -->
    <div class="absolute bottom-10 w-full max-w-sm px-4 text-center z-10">
        <div class="bg-slate-900/50 backdrop-blur-md p-6 rounded-2xl border border-slate-700/50 shadow-2xl">
            <label for="techniqueSelect" class="block text-xs font-semibold text-blue-300 mb-2 tracking-widest uppercase">
                Select Technique
            </label>
            <select id="techniqueSelect" class="w-full p-2.5 rounded-lg text-sm transition-colors cursor-pointer mb-2">
                <option value="box">Box Breathing (4-4-4-4)</option>
                <option value="relax">4-7-8 Relaxing</option>
                <option value="coherent">Coherent (6-0-6-0)</option>
                <option value="energy">Energizing (4-0-4-0)</option>
                <option value="sleep">Deep Sleep (4-7-8)</option>
            </select>
            <div id="descriptionDisplay" class="text-xs text-slate-400 mt-2 font-light">
                Inhale 4s, Hold 4s, Exhale 4s, Hold 4s
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('breathCanvas');
        const ctx = canvas.getContext('2d');
        const techniqueSelect = document.getElementById('techniqueSelect');
        const descDisplay = document.getElementById('descriptionDisplay');

        // --- Configuration ---
        const techniques = {
            'box': { 
                name: "Box Breathing", 
                phases: [4000, 4000, 4000, 4000], // In, Hold Full, Out, Hold Empty
                desc: "Inhale 4s, Hold 4s, Exhale 4s, Hold 4s"
            },
            'relax': { 
                name: "4-7-8 Relaxing", 
                phases: [4000, 7000, 8000, 0], // No empty hold
                desc: "Inhale 4s, Hold 7s, Exhale 8s"
            },
            'coherent': { 
                name: "Coherent Breathing", 
                phases: [5500, 0, 5500, 0], 
                desc: "Inhale 5.5s, Exhale 5.5s (Heart Balance)"
            },
            'energy': { 
                name: "Energizing", 
                phases: [4000, 0, 4000, 0], 
                desc: "Inhale 4s, Exhale 4s"
            },
            'sleep': {
                name: "Deep Sleep",
                phases: [4000, 7000, 8000, 0],
                desc: "Inhale 4s, Hold 7s, Exhale 8s"
            }
        };

        let currentTechnique = techniques['box'];
        
        // --- State ---
        // 0: Inhale, 1: Hold (Full), 2: Exhale, 3: Hold (Empty)
        let phaseIndex = 0; 
        let phaseStartTime = 0;
        let width, height;

        // --- Initialization ---
        function resize() {
            width = window.innerWidth;
            height = window.innerHeight;
            canvas.width = width;
            canvas.height = height;
        }
        window.addEventListener('resize', resize);
        resize();

        techniqueSelect.addEventListener('change', (e) => {
            currentTechnique = techniques[e.target.value];
            descDisplay.innerText = currentTechnique.desc;
            resetCycle();
        });

        function resetCycle() {
            phaseIndex = 0;
            phaseStartTime = performance.now();
        }

        // Standard Easing function for smoother movement than linear
        function easeInOutSine(x) {
            return -(Math.cos(Math.PI * x) - 1) / 2;
        }

        function getPhaseLabel(index) {
            switch(index) {
                case 0: return "Breathe In...";
                case 1: return "Hold...";
                case 2: return "Breathe Out...";
                case 3: return "Hold...";
                default: return "";
            }
        }

        function draw(timestamp) {
            if (!phaseStartTime) phaseStartTime = timestamp;

            // 1. Calculate Timing
            let elapsed = timestamp - phaseStartTime;
            let duration = currentTechnique.phases[phaseIndex];

            // Handle phase transitions
            // Some phases might be 0ms (e.g., no hold), so we loop until we hit a non-zero phase or process them
            while (elapsed >= duration) {
                // Move to next phase
                elapsed -= duration;
                phaseStartTime = timestamp - elapsed; // Adjust start time to preserve overflow time
                phaseIndex = (phaseIndex + 1) % 4;
                duration = currentTechnique.phases[phaseIndex];
                
                // If duration is 0, we immediately skip to next, but in while loop context it will handle itself
                if (duration === 0) continue; 
            }

            // 2. Calculate Progress (0.0 to 1.0)
            // Guard against divide by zero if a phase is 0 (though while loop should catch it)
            const progress = duration > 0 ? elapsed / duration : 1;
            const easedProgress = easeInOutSine(progress);

            // 3. Calculate Expansion Factor (0.0 = Empty, 1.0 = Full)
            let expansion = 0;
            
            if (phaseIndex === 0) {
                // Inhale: 0 -> 1
                expansion = easedProgress;
            } else if (phaseIndex === 1) {
                // Hold Full: Stay at 1
                expansion = 1;
            } else if (phaseIndex === 2) {
                // Exhale: 1 -> 0
                expansion = 1 - easedProgress;
            } else {
                // Hold Empty: Stay at 0
                expansion = 0;
            }

            // --- Drawing ---
            ctx.clearRect(0, 0, width, height);
            
            const cx = width / 2;
            const cy = height / 2;
            
            // Visual Config
            const minSize = Math.min(width, height) * 0.25;
            const maxSize = Math.min(width, height) * 0.45; // Max expanded size
            const sizeDiff = maxSize - minSize;
            
            const currentSize = minSize + (expansion * sizeDiff);
            
            // --- Glow Effect ---
            // Glow intensity changes with breath
            const glowAlpha = 0.2 + (expansion * 0.3); // 0.2 to 0.5 opacity
            const glowRadius = 20 + (expansion * 40);
            
            const gradient = ctx.createRadialGradient(cx, cy, currentSize/2, cx, cy, currentSize/2 + glowRadius);
            gradient.addColorStop(0, `rgba(96, 165, 250, ${glowAlpha})`);
            gradient.addColorStop(1, 'rgba(96, 165, 250, 0)');
            
            ctx.fillStyle = gradient;
            ctx.beginPath();
            ctx.arc(cx, cy, currentSize + glowRadius, 0, Math.PI * 2);
            ctx.fill();

            // --- The Box ---
            ctx.save();
            ctx.translate(cx, cy);
            
            // Subtle color shift: Darker blue when empty, Brighter/Cyan when full
            // RGB interpolation: 
            // Empty: 59, 130, 246 (Blue-500)
            // Full:  147, 197, 253 (Blue-300)
            
            // Simple approach: overlay a white opacity
            ctx.fillStyle = '#3b82f6'; // Base Blue
            ctx.shadowColor = '#60a5fa';
            ctx.shadowBlur = 20 + (expansion * 20); // Blur increases with size
            
            const halfSize = currentSize / 2;
            const radius = 25; // Rounded corners

            ctx.beginPath();
            ctx.roundRect(-halfSize, -halfSize, currentSize, currentSize, radius);
            ctx.fill();
            
            // Light overlay based on expansion to brighten it up
            ctx.fillStyle = `rgba(255, 255, 255, ${expansion * 0.3})`;
            ctx.beginPath();
            ctx.roundRect(-halfSize, -halfSize, currentSize, currentSize, radius);
            ctx.fill();
            
            ctx.restore();

            // --- Text ---
            ctx.font = '300 28px "Segoe UI", sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillStyle = 'rgba(255, 255, 255, 0.95)';
            
            const label = getPhaseLabel(phaseIndex);
            ctx.fillText(label, cx, cy);

            // --- Progress Indicator (Optional Ring) ---
            // Draw a thin arc indicating how much time is left in current phase
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.2)';
            ctx.lineWidth = 3;
            ctx.beginPath();
            // Start at top (-PI/2)
            ctx.arc(cx, cy, currentSize/2 + 20, -Math.PI/2, (-Math.PI/2) + (Math.PI * 2 * progress));
            ctx.stroke();

            requestAnimationFrame(draw);
        }

        requestAnimationFrame(draw);

    </script>
</body>
</html>